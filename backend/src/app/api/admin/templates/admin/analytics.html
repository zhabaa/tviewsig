{% extends "admin/base.html" %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ - –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è{% endblock %}
{% block page_title %}üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤{% endblock %}

{% block page_actions %}
<div class="btn-toolbar mb-2 mb-md-0">
    <div class="btn-group me-2">
        <select id="timeRange" class="form-select form-select-sm">
            <option value="7">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
            <option value="30" selected>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
            <option value="90">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 90 –¥–Ω–µ–π</option>
            <option value="365">–ü–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥</option>
        </select>
    </div>
    <button class="btn btn-sm btn-outline-secondary" onclick="updateCharts()">
        <i class="bi bi-arrow-clockwise"></i> –û–±–Ω–æ–≤–∏—Ç—å
    </button>
</div>
{% endblock %}

{% block extra_css %}
<style>
.chart-container {
    position: relative;
    height: 300px;
    margin-bottom: 20px;
}
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
}
.stat-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: #2c3e50;
}
.stat-label {
    color: #7f8c8d;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 1px;
}
</style>
{% endblock %}

{% block content %}
<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value" id="totalSignals">{{ stats.total_signals|default(0) }}</div>
        <div class="stat-label">–í—Å–µ–≥–æ —Å–∏–≥–Ω–∞–ª–æ–≤</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="avgDaily">{{ stats.avg_daily|default(0) }}</div>
        <div class="stat-label">–°—Ä–µ–¥–Ω–µ –≤ –¥–µ–Ω—å</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="uniqueBots">{{ stats.unique_bots|default(0) }}</div>
        <div class="stat-label">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –±–æ—Ç–æ–≤</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="uniqueSymbols">{{ stats.unique_symbols|default(0) }}</div>
        <div class="stat-label">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–∞—Ä</div>
    </div>
</div>

<div class="row">
    <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–æ —á–∞—Å–∞–º -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üìà –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="hourlyChart"></canvas>
                </div>
                <p class="text-muted small">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫</p>
            </div>
        </div>
    </div>
    
    <!-- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –±–æ—Ç–∞–º -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">ü§ñ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –±–æ—Ç–∞–º</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="botsChart"></canvas>
                </div>
                <p class="text-muted small">–¢–æ–ø 10 —Å–∞–º—ã—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–æ—Ç–æ–≤</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- –¢–æ–ø —Å–∏–º–≤–æ–ª–æ–≤ -->
    <div class="col-md-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üí∞ –¢–æ–ø —Ç–æ—Ä–≥–æ–≤—ã—Ö –ø–∞—Ä</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>–ü–∞—Ä–∞</th>
                                <th>–°–∏–≥–Ω–∞–ª–æ–≤</th>
                                <th>BUY</th>
                                <th>SELL</th>
                                <th>–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ</th>
                                <th>–ü–æ—Å–ª–µ–¥–Ω—è—è —Ü–µ–Ω–∞</th>
                            </tr>
                        </thead>
                        <tbody id="symbolsTable">
                            {% for symbol in top_symbols %}
                            <tr>
                                <td><strong>{{ symbol.symbol }}</strong></td>
                                <td>{{ symbol.signal_count }}</td>
                                <td><span class="badge bg-success">{{ symbol.buy_count or 0 }}</span></td>
                                <td><span class="badge bg-danger">{{ symbol.sell_count or 0 }}</span></td>
                                <td>
                                    {% set ratio = (symbol.buy_count / symbol.signal_count * 100) if symbol.signal_count > 0 else 0 %}
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-success" style="width: {{ ratio }}%">
                                            {{ "%.0f"|format(ratio) }}%
                                        </div>
                                    </div>
                                </td>
                                <td>${{ "%.2f"|format(symbol.avg_price) if symbol.avg_price else '‚Äî' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üìÖ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="dailyChart"></canvas>
                </div>
                <p class="text-muted small">–°–∏–≥–Ω–∞–ª—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</p>
            </div>
        </div>
        
        <!-- –î–µ–π—Å—Ç–≤–∏—è -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">‚ö°Ô∏è –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="exportData()">
                        <i class="bi bi-download"></i> –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
                    </button>
                    <button class="btn btn-outline-secondary" onclick="clearOldData()">
                        <i class="bi bi-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
let hourlyChart, botsChart, dailyChart;

document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    updateStats();
});

function initCharts() {
    // –ì—Ä–∞—Ñ–∏–∫ –ø–æ —á–∞—Å–∞–º
    const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
    hourlyChart = new Chart(hourlyCtx, {
        type: 'line',
        data: {
            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
            datasets: [{
                label: '–°–∏–≥–Ω–∞–ª–æ–≤ –≤ —á–∞—Å',
                data: {{ hourly_stats|map(attribute='count')|list|tojson }},
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–≥–Ω–∞–ª–æ–≤'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: '–ß–∞—Å –¥–Ω—è'
                    }
                }
            }
        }
    });
    
    // –ì—Ä–∞—Ñ–∏–∫ –ø–æ –±–æ—Ç–∞–º
    const botsCtx = document.getElementById('botsChart').getContext('2d');
    botsChart = new Chart(botsCtx, {
        type: 'doughnut',
        data: {
            labels: {{ top_bots|map(attribute='bot_name')|list|tojson|safe }},
            datasets: [{
                data: {{ top_bots|map(attribute='signal_count')|list|tojson }},
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                    '#9966FF', '#FF9F40', '#8AC926', '#1982C4',
                    '#6A4C93', '#FF595E'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
    
    // –ì—Ä–∞—Ñ–∏–∫ –ø–æ –¥–Ω—è–º
    const dailyCtx = document.getElementById('dailyChart').getContext('2d');
    dailyChart = new Chart(dailyCtx, {
        type: 'bar',
        data: {
            labels: {{ daily_stats|map(attribute='date')|list|tojson }},
            datasets: [{
                label: '–°–∏–≥–Ω–∞–ª–æ–≤ –≤ –¥–µ–Ω—å',
                data: {{ daily_stats|map(attribute='count')|list|tojson }},
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgb(75, 192, 192)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

async function updateCharts() {
    const days = document.getElementById('timeRange').value;
    
    try {
        const response = await fetch(`/admin/api/analytics?days=${days}`);
        const data = await response.json();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
        hourlyChart.data.datasets[0].data = data.hourly_data;
        hourlyChart.update();
        
        botsChart.data.labels = data.top_bots_labels;
        botsChart.data.datasets[0].data = data.top_bots_data;
        botsChart.update();
        
        dailyChart.data.labels = data.daily_labels;
        dailyChart.data.datasets[0].data = data.daily_data;
        dailyChart.update();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        document.getElementById('totalSignals').textContent = data.total;
        document.getElementById('avgDaily').textContent = data.avg_daily.toFixed(1);
        document.getElementById('uniqueBots').textContent = data.unique_bots;
        document.getElementById('uniqueSymbols').textContent = data.unique_symbols;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
        updateSymbolsTable(data.top_symbols);
        
    } catch (error) {
        console.error('Error updating charts:', error);
        alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö');
    }
}

function updateSymbolsTable(symbols) {
    const table = document.getElementById('symbolsTable');
    table.innerHTML = '';
    
    symbols.forEach(symbol => {
        const ratio = symbol.signal_count > 0 ? 
            (symbol.buy_count / symbol.signal_count * 100) : 0;
        
        const row = `
            <tr>
                <td><strong>${symbol.symbol}</strong></td>
                <td>${symbol.signal_count}</td>
                <td><span class="badge bg-success">${symbol.buy_count || 0}</span></td>
                <td><span class="badge bg-danger">${symbol.sell_count || 0}</span></td>
                <td>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-success" style="width: ${ratio}%">
                            ${ratio.toFixed(0)}%
                        </div>
                    </div>
                </td>
                <td>$${symbol.avg_price ? symbol.avg_price.toFixed(2) : '‚Äî'}</td>
            </tr>
        `;
        table.innerHTML += row;
    });
}

async function updateStats() {
    try {
        const response = await fetch('/admin/api/quick-stats');
        const data = await response.json();
        
        if (data.total_signals) {
            document.getElementById('totalSignals').textContent = data.total_signals;
            document.getElementById('todaySignals').textContent = data.today_signals;
            document.getElementById('activeBots').textContent = data.active_bots;
        }
    } catch (error) {
        console.error('Error updating stats:', error);
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
async function exportData() {
    try {
        const response = await fetch('/admin/api/export');
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `signals_export_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö');
    }
}

// –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
async function clearOldData() {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–∏–≥–Ω–∞–ª—ã —Å—Ç–∞—Ä—à–µ 90 –¥–Ω–µ–π? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
        return;
    }
    
    try {
        const response = await fetch('/admin/api/clear-old', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            alert(`–£–¥–∞–ª–µ–Ω–æ ${result.deleted} —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π`);
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + result.error);
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
    }
}

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
setInterval(updateStats, 60000);
</script>
{% endblock %}
